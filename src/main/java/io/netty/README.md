## Netty

### 一、认识Netty

* Netty是一个基于NIO封装的一个网络框架，它的功能非常简单：就是能快速并且很简单的开发出一套高性能的网络应用程序。（官网：https://netty.io）
* 官方文档(**4.1.x版本**)：[https://netty.io/wiki/user-guide-for-4.x.html#wiki-h2-3](https://netty.io/wiki/user-guide-for-4.x.html#wiki-h2-3)

### 二、为什么使用Netty

* JDK有NIO解决了BIO吞吐量低、阻塞的问题，那为什么不使用NIO，而使用Netty呢？这是因为使用NIO非常复杂，我们需要熟练掌握：**Selector、ServerSocketChannel、SocketChannel、ByteBuffer**。特别是ByteBuffer，需要详细了解它的**mark、position、limit、capacity**四个变量的值，稍不留神就容易写出bug。而且，开发网络应用程序会出现很多异常情况：**断连重连、网络闪断、心跳处理、半包读写、网络阻塞、异常流**。在使用NIO开发网络应用程序时，这些异常情况的处理都会将**工作量和难度**加大。而Netty对NIO的api做了良好的封装，良好的解决了上述问题。且**`Netty拥有高性能、高吞吐量、延迟低、减少资源消耗、最小化不必要的内存复制`**等优点。

### 三、Netty的使用场景：

* 互联网行业：在分布式系统中，各个节点之间需要远程服务调用，高性能的RPC框架必不可少，Netty作为异步高性能的通信框架，往往作为基础通信组件被这些RPC框架使用。典型的就是阿里的dubbo框架使用Dubbo协议进行节点间通信，Dubbo协议默认使用Netty作为基础通信组件。RocketMQ使用的也是Netty作为基础通信组件。
* 其他行业：所有使用java语言开发需要通信的应用， 都会优先选择Netty框架，它本身就提供了TCP/UDP和HTTP协议栈。
* 通常，要开发一个web应用程序的时候，用的最多的是http协议，而实现http协议的web容器有很多：tocat、jetty、nginx。如果我们的应用需要一种自定义的网络协议的话，这个时候就得用netty来实现了。比如大名鼎鼎的dubbo框架的dubbo协议，其内部用的就是netty来做网络传输的

### 四、Netty的优秀设计精髓

* 主从的Reactor线程模型（其实也不算是它的，而是利用了java NIO中Reactor线程模型）
* NIO多路复用非阻塞（这也不算是它的，因为这是Java已经提供了的，其实NIO也是会阻塞的，只不过在特殊的场景下，它的阻塞就会变得非阻塞了）
* **无锁串行化设计思想**：这个算是一个点，因为在netty中每一个channel内部都会维护一系列的pipeline，而且使用的是单线程去执行，这样的好处是避免了并发的数据共享的安全性导致吞吐量变低。我们都知道，现在的cpu是多核的，完全可以利用多核的优势来进行并发操作，提高程序的处理速度。实际上，串行化的执行效率比并行化的执行效率是低很多的，但是为什么netty的串行化设计思想也能变得很快呢？这是因为，我们可以通过调整NIO的线程数，可以同时启动多个串行化的线程并行运行。这也依赖于reactor的主从线程模型，因为，我完全可以扩大线程池的线程，减少一个线程处理的客户端请求数量。这就有点类似于，机器横向扩容，提高系统的QPS。
* 支持高性能序列化的协议：这个待确认
* 零拷贝（这也不能算是它的，它使用的Java byteBuf自带的直接内存 api）
* ByteBuf内存池设计：这个很nice，大家都知道计算机的内存是散列着的，而netty要进行数据交互，可能会利用到一些内存块，而内存块就是一系列连续的内存组成的。为了避免临时创建内存块时，出现内存散乱而无法创建内存块的情况，netty设计了**内存池**，类似于线程池，在启动的时候，就把一系列连续的内存给占用，添加数个内存块，然后组成内存池。
* 灵活的TCP参数配置：可以采用options的api来配置tcp相关的配置
* 并发优化：使用到了很多乐观锁操作，众所周知，乐观锁相对于悲观锁的性能提升是非常大的。但是乐观锁的使用会加大编程的复杂度，而netty使用的是乐观锁来保证线程安全问题，这无疑增加了编程的复杂度。

### 五、弹幕系统

* 特点：

  ```text
  1、数据实时性高：你发我收，毫秒之差（但相比于聊天程序而言，接收到数据的时间可以延迟)
  2、并发量大：一人吐槽，万人观看
  3、对数据一致性要求不高（允许你发的弹幕，我没有看到），如果在春节联欢晚会上，可以只在屏幕上显示20%的弹幕，将剩余的80%给忽略或者延迟显示（可以有效的保护服务器资源）
  ```

* 需要使用到websocket协议（websocket协议不是独立存在的，它是依赖于http协议，在http协议的请求头中指定：Upgrade为websocket的话，请求就会使用websocket协议进行处理）。在HTTP协议中，请求头是有限制大小的，比如nginx中，请求头不能超过1M。

* HTTP是文本协议，而websocket是二进制协议，这也说明了websocket协议的请求会非常轻，可能仅有几bit大小。

### 六、Netty在Dubbo中的应用